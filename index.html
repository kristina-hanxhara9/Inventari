<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventari</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, button { margin: 10px 5px; padding: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background-color: #f4f4f4; }
        .scrollable { max-height: 400px; overflow-y: auto; display: block; }
        @media (max-width: 600px) {
            table { font-size: 14px; }
            input, button { margin: 5px 0; width: 100%; }
        }
    </style>
</head>
<body>
    <h1>Inventari</h1>

    <h2>Produktet</h2>
    <div class="scrollable">
        <table>
            <thead>
                <tr>
                    <th>Produktet</th>
                    <th>Cmimi (per cope)</th>
                    <th>Sasia</th>
                    <th>Kostoja Totale</th>
                    <th>Pjesa e Pare e Dites</th>
                    <th>Pjesa e Dyte e Dites</th>
                    <th>Totali Përfundimtar</th>
                </tr>
            </thead>
            <tbody id="productTable"></tbody>
        </table>
    </div>

    <h3>Kostoja Totale Ditore: L<span id="dailyTotal">0.00</span></h3>
    <button onclick="saveRecord()">Ruaji të dhënat</button>

    <h2>Regjistrime</h2>
    <button onclick="exportToCSV()">Shkarko</button>
    <div class="scrollable">
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Detajet</th>
                    <th>Totali</th>
                </tr>
            </thead>
            <tbody id="recordTable"></tbody>
        </table>
    </div>

    <script>
        const products = [
             { product: "Ekmek", price: 1.5 },
            { product: "Torte", price: 12.000 },
            { product: "Torte", price: 10.000 },
            { product: "Zupa", price: 1.000 },
            { product: "Zupa", price: 1.200 },
            { product: "Trilece", price: 5.000 },
            { product: "Trilece", price: 1.500 },
            { product: "Trilece", price: 7.000 },
            { product: "Kausha", price: 10.000 },
            { product: "Peta", price: 1.000 },
            { product: "Peta e madhe", price: 12.000 },
            { product: "Rulon", price: 10.000 },
            { product: "Pastashu", price: 1.000 },
            { product: "Pastashu", price: 1.200 },
            { product: "Kompeka", price: 10.000 },
            { product: "Revani", price: 1.5 },
            { product: "Hashure", price: 12.000 },
            { product: "Bakllava", price: 10.000 },
            { product: "Torte racion", price: 1.5 },
            { product: "Porcione", price: 12.000 },
            { product: "Torte", price: 10.000 },
            { product: "Tolluma", price: 1.5 },
            { product: "Buke franxholla", price: 12.000 },
            { product: "Franxholla", price: 6.000 },
            { product: "Buke me topa", price: 10.000 },
            { product: "Buke masive", price: 1.5 },
            { product: "Buke me fara", price: 12.000 },
            { product: "Buke fshati", price: 10.000 },
            { product: "Buke e rrumbullaket", price: 1.5 },
            { product: "Buke e gjate", price: 12.000 },
            { product: "Kulac", price: 6.000 },
            { product: "Buke me ullinj", price: 12.000 },
            { product: "Buke e verdhe", price: 6.000 },
            { product: "Buke integrale", price: 10.000 },
            { product: "Buke Bogeti", price: 1.5 },
            { product: "Buke misri", price: 12.000 },
            { product: "Buke thekre", price: 10.000 },
            { product: "Pite", price: 1.5 },
            { product: "Simite", price: 12.000 },
            { product: "Sanduic", price: 6.000 },
            { product: "Sanduic me fara", price: 12.000 },
            { product: "Sanduic i verdhe", price: 6.000 },
            { product: "Briosh", price: 10.000 },
            { product: "Donat", price: 1.5 },
            { product: "Byrek", price: 5.00 },
            { product: "Byrek", price: 7.00 },
            { product: "Pica", price: 1.5 },
            { product: "Kos 380gr", price: 12.000 },
            { product: "Kos bidon", price: 6.000 },
            { product: "Kos i madh", price: 12.000 },
            { product: "Kos 200", price: 6.000 },
            { product: "Dhalle bidon", price: 10.000 },
            { product: "Dhalle karton", price: 1.5 },
            { product: "Wumesht bidon", price: 12.000 },
            { product: "Salce kosi 900gr", price: 10.000 },
            { product: "Salce kosi 450gr", price: 1.5 },
            { product: "Kos frutash", price: 12.000 },
            { product: "Boze", price: 6.000 },
            { product: "Uje Bukanik 7kg", price: 12.000 },
            { product: "Uje Bukanik 1.5kg", price: 6.000 },
            { product: "U Bukanik vgl", price: 12.000 },
            { product: "U Lajthiza 5kg", price: 6.000 },
            { product: "U Lajthiza 2kg", price: 10.000 },
            { product: "U Lajthiza 1.5kg", price: 1.5 },
            { product: "U Lajthiza vgl", price: 12.000 },
            { product: "U Tepelena 5kg", price: 10.000 },
            { product: "U Tepelena 1.5kg", price: 1.5 },
            { product: "Tepelena vgl", price: 12.000 },
            { product: "Kola Bidon 1.5 kg", price: 6.000 },
            { product: "Kola Bidon 1 kg", price: 1.5 },
            { product: "Kola vgl", price: 12.000 },
            { product: "Monster", price: 10.000 },
            { product: "Uje vitamina", price: 1.5 },
            { product: "Boze natyrale", price: 12.000 },
            { product: "Qumet", price: 6.000 },
            { product: "Uje", price: 1.5 },
        ];
        const emptyRows = Array.from({ length: 10 }, () => ({ product: "", price: 0 }));
        const allProducts = [...products, ...emptyRows];
        let records = [];

        const productTable = document.getElementById("productTable");
        const recordTable = document.getElementById("recordTable");
        const dailyTotalDisplay = document.getElementById("dailyTotal");

        function updateProductTable() {
            productTable.innerHTML = '';
            allProducts.forEach((product, index) => {
                const row = document.createElement("tr");
                 row.setAttribute('data-index', index);
                // Only show non-empty products in the table
                if (product.product) {
                    row.innerHTML = `
                        <td>${product.product}</td>
                        <td>${product.price.toFixed(2)}</td>
                        <td><input type="number" value="0" class="quantity"/></td>
                        <td class="total-cost">0.00</td>
                        <td><input type="number" value="0" class="first-part" /></td>
                        <td><input type="number" value="0" class="second-part" /></td>
                        <td class="final-total">0.00</td>
                    `;
                    productTable.appendChild(row);
                }
            });

            // Add event listeners for each input field to update the total cost
            const inputs = productTable.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', updateDailyTotal);
            });
        }


        function updateDailyTotal(event) {
            const row = event.target.closest('tr');
              if (!row) return;

            const index = row.getAttribute('data-index');
           if (index === null) return;


             const product = allProducts[index];
               if (!product) return;
               
               const quantityInput = row.querySelector('input.quantity');
                const firstPartInput = row.querySelector('input.first-part');
                const secondPartInput = row.querySelector('input.second-part');


                const quantity = parseFloat(quantityInput.value) || 0;
                const firstPart = parseFloat(firstPartInput.value) || 0;
                const secondPart = parseFloat(secondPartInput.value) || 0;


                // Calculate the total cost as quantity * price
                 const totalCost = product.price * quantity;

                // Update the total cost for the current row (Kostoja Totale)
                 const totalCostCell = row.querySelector('td.total-cost');
                 if(totalCostCell){
                      totalCostCell.textContent = totalCost.toFixed(2);
                  }

                // Calculate the final total by adding additional parts
                const finalTotal = totalCost + firstPart + secondPart;
                const finalTotalCell = row.querySelector('td.final-total');
                 if(finalTotalCell){
                      finalTotalCell.textContent = finalTotal.toFixed(2);
                  }

              let total = 0;
            productTable.querySelectorAll('tr[data-index]').forEach(row => {
                const rowIndex = row.getAttribute('data-index');
                const finalTotalCell = row.querySelector('td.final-total');
                   if (finalTotalCell && rowIndex !== null) {
                       total += parseFloat(finalTotalCell.textContent) || 0;
                   }
           });
            dailyTotalDisplay.textContent = total.toFixed(2);
            }
        async function saveRecord() {
            const date = new Date().toLocaleDateString();
              const details = Array.from(productTable.querySelectorAll('tr[data-index]')).map(row => {
                const index = row.getAttribute('data-index');
                  if (index === null) return null;
                const product = allProducts[index];
                   if (!product) return null;

               const quantityInput = row.querySelector('input.quantity');
                const firstPartInput = row.querySelector('input.first-part');
                const secondPartInput = row.querySelector('input.second-part');

                 const quantity = parseFloat(quantityInput.value) || 0;
                const firstPart = parseFloat(firstPartInput.value) || 0;
                const secondPart = parseFloat(secondPartInput.value) || 0;


                const totalCost = product.price * quantity;
                const finalTotal = totalCost + parseFloat(firstPart) + parseFloat(secondPart);

                return finalTotal > 0 ? { product: product.product, quantity, firstPart, secondPart, totalCost, finalTotal } : null;
            }).filter(Boolean);

            const total = details.reduce((sum, item) => sum + item.finalTotal, 0);

            try {
                const response = await fetch('/api/records', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ date, details, total }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Server error", errorData);
                    alert('Error saving the record. Please check the server logs for more details.');
                   return;
                 }
                const responseData = await response.json();
                  alert(responseData.message || 'Record saved successfully!');
            } catch (error) {
                console.error("Network error", error);
                 alert('Error saving the record. Please check the server logs for more details.');
            }
        }


        updateProductTable();
    </script>
</body>
</html>

